<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Let's create a Coverage Analyzer, Part 2 | ~stesie's musings</title>
<meta name=keywords content="Java,Java Agents,Byte Code"><meta name=description content="This is part two of my journey creating a Java (Line) Coverage Analyzer.
Here we&rsquo;ll actually implement the Byte Code Instrumentation, as pointed out in the first part.
Since processing the Byte Code itself, i.e. reading the classes, finding the methods, processing line number information, is in itself a huge task, let&rsquo;s rely on the ASM library for that. After all JaCoCo and Cobertura also rely on that, so this seems to be a valid choice üòÇ"><meta name=author content><link rel=canonical href=https://stefansiegl.de/2025/02/lets-create-a-coverage-analyzer-part-2/><link crossorigin=anonymous href=/assets/css/stylesheet.afb210dc38e6603228aff7827128220ab3093c72a2408955745ba993ab2977e6.css integrity="sha256-r7IQ3DjmYDIor/eCcSgiCrMJPHKiQIlVdFupk6spd+Y=" rel="preload stylesheet" as=style><link rel=icon href=https://stefansiegl.de/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://stefansiegl.de/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://stefansiegl.de/favicon-32x32.png><link rel=apple-touch-icon href=https://stefansiegl.de/apple-touch-icon.png><link rel=mask-icon href=https://stefansiegl.de/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://stefansiegl.de/2025/02/lets-create-a-coverage-analyzer-part-2/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Let's create a Coverage Analyzer, Part 2"><meta property="og:description" content="This is part two of my journey creating a Java (Line) Coverage Analyzer.
Here we&rsquo;ll actually implement the Byte Code Instrumentation, as pointed out in the first part.
Since processing the Byte Code itself, i.e. reading the classes, finding the methods, processing line number information, is in itself a huge task, let&rsquo;s rely on the ASM library for that. After all JaCoCo and Cobertura also rely on that, so this seems to be a valid choice üòÇ"><meta property="og:type" content="article"><meta property="og:url" content="https://stefansiegl.de/2025/02/lets-create-a-coverage-analyzer-part-2/"><meta property="article:section" content="pages"><meta property="article:published_time" content="2025-02-26T00:00:00+00:00"><meta property="article:modified_time" content="2025-02-26T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Let's create a Coverage Analyzer, Part 2"><meta name=twitter:description content="This is part two of my journey creating a Java (Line) Coverage Analyzer.
Here we&rsquo;ll actually implement the Byte Code Instrumentation, as pointed out in the first part.
Since processing the Byte Code itself, i.e. reading the classes, finding the methods, processing line number information, is in itself a huge task, let&rsquo;s rely on the ASM library for that. After all JaCoCo and Cobertura also rely on that, so this seems to be a valid choice üòÇ"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Pages","item":"https://stefansiegl.de/pages/"},{"@type":"ListItem","position":2,"name":"Let's create a Coverage Analyzer, Part 2","item":"https://stefansiegl.de/2025/02/lets-create-a-coverage-analyzer-part-2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Let's create a Coverage Analyzer, Part 2","name":"Let\u0027s create a Coverage Analyzer, Part 2","description":"This is part two of my journey creating a Java (Line) Coverage Analyzer.\nHere we\u0026rsquo;ll actually implement the Byte Code Instrumentation, as pointed out in the first part.\nSince processing the Byte Code itself, i.e. reading the classes, finding the methods, processing line number information, is in itself a huge task, let\u0026rsquo;s rely on the ASM library for that. After all JaCoCo and Cobertura also rely on that, so this seems to be a valid choice üòÇ","keywords":["Java","Java Agents","Byte Code"],"articleBody":"This is part two of my journey creating a Java (Line) Coverage Analyzer.\nHere we‚Äôll actually implement the Byte Code Instrumentation, as pointed out in the first part.\nSince processing the Byte Code itself, i.e. reading the classes, finding the methods, processing line number information, is in itself a huge task, let‚Äôs rely on the ASM library for that. After all JaCoCo and Cobertura also rely on that, so this seems to be a valid choice üòÇ\nHello ASM Usage of ASM is after all pretty simple. It provides two classes ClassReader and ClassWriter, which both do what their names promise. ASM heavily relies on the visitor pattern, and ClassWriter itself extends the abstract ClassVisitor class.\nThe constructor of ClassReader does take either a byte[] or an InputStream, hence nothing fancy. A very simple example would look like this:\npublic byte[] instrumentClass(final byte[] classBytes) throws IOException { final var reader = new ClassReader(classBytes); final var writer = new ClassWriter(0); reader.accept(writer, 0); return writer.toByteArray(); } ‚Ä¶ obviously this in itself isn‚Äôt very useful, since it doesn‚Äôt do anything üôÇ\nBut we can bring our own implementation of ClassVisitor to the table, which itself takes a ClassVisitor to delegate to and then starts taking action:\n@Log public class CoveristaClassVisitor extends ClassVisitor { public CoveristaClassVisitor(final ClassVisitor writer) { super(Opcodes.ASM9, writer); } @Override public MethodVisitor visitMethod(final int access, final String name, final String descriptor, final String signature, final String[] exceptions) { log.fine(\"visitMethod: \" + name); return super.visitMethod(access, name, descriptor, signature, exceptions); } } Nothing fancy here, we just pass the ClassVisitor to the parent constructor and override the visitMethod, logging the method name.\n‚ÑπÔ∏è You might wonder what the Opcodes.ASM9 bit is. It‚Äôs just setting the ASM API version we‚Äôre relying on. And as of this writing, ASM9 is the latest (stable) one. Given we have a ClassVisitor now, let‚Äôs hook that into the instrumentClass method from above. The reader instance delegates to our visitor. Our visitor delegates to the writer. Like this:\npublic byte[] instrumentClass(final byte[] classBytes) throws IOException { final var reader = new ClassReader(classBytes); final var writer = new ClassWriter(0); final var classVisitor = new CoveristaClassVisitor(writer); reader.accept(classVisitor, 0); return writer.toByteArray(); } ‚Ä¶ and that‚Äôs it. We have a very simple first ClassVisitor that logs all the method definitions it finds.\nAnd given the return type of visitMethod you might already have noticed that there‚Äôs a MethodVisitor as well. Given that we actually want to instrument the method, the obvious next step is to create our own implementation of such a MethodVisitor and hook it into our visitMethod call path.\n@Log public class CoveristaMethodVisitor extends MethodVisitor { public CoveristaMethodVisitor(final MethodVisitor methodVisitor) { super(Opcodes.ASM9, methodVisitor); } @Override public void visitLineNumber(final int line, final Label start) { log.finer(\"instrument line: \" + line); super.visitLineNumber(line, start); super.visitMethodInsn(Opcodes.INVOKESTATIC, \"de/brokenpipe/dojo/undercovered/coverista/Tracker\", \"track\", \"()V\", false); } } Again, the implementation is very straight forward. We receive a MethodVisitor instance, which we pass to the parent constructor. Then we override the visitLineNumber method, log the invocation, delegate to the next visitor first, ‚Ä¶ and then the magic happens: we also call visitMethodInsn, and ask it to write an INVOKESTATIC opcode for us.\nThe arguments to that invocation are also very simple: the (internal) class name, the method name and the type signature. The final false is assigned to an argument named isInterface.\nInternally the visitMethodInsn call will allocate an entry in the constants pool and write the INVOKESTATIC opcode, referencing the new constant. ASM also does some bookkeeping, so it won‚Äôt put the same constant to the pool over and over. Therefore we can happily invoke visitMethodInsn for each and every line number label we‚Äôll find, and the constant will be added only once.\nConnecting it to the Agent As we‚Äôve seen in the first part, our agent just needs to provide a premain method and register a transformer there. Like this:\n@Log public class UndercoveredAgent { public static void premain(final String agentArgs, final Instrumentation inst) { log.info(\"[Agent] In premain method\"); inst.addTransformer(new UndercoverTransformer()); } } The Transformer just has to implement, as shown, the transform method:\n@Log public class UndercoverTransformer implements ClassFileTransformer { @Override public byte[] transform(final Module module, final ClassLoader loader, final String className, final Class\u003c?\u003e classBeingRedefined, final ProtectionDomain protectionDomain, final byte[] classfileBuffer) { log.info(\"transforming \" + className); try { return new Instrumenter().instrumentClass(classfileBuffer); } catch (final IOException e) { throw new RuntimeException(\"instrumentation of '\" + className + \"' failed\", e); } } } ‚Ä¶ and the rest we‚Äôve seen above.\nThe full source code of the above implementation can be found on GitHub. Make sure to check out the branch named naive, which matches the current progress. The repo contains a multi-module Maven setup, therefore just run mvn package to build.\nFinally, time has come to run it for the first time. The basic invocation of the minimalist demo application looks like this:\n$ java -cp demo/target/demo-1.0-SNAPSHOT.jar de.brokenpipe.dojo.undercovered.demo.Demo Hello World to the blarg Obviously we want to add our agent to the mix, and also configure logging, so our log output on fine \u0026 finer levels will show up:\n$ java -Djava.util.logging.config.file=./coverista/src/main/resources/logging.properties -javaagent:agent/target/agent-1.0-SNAPSHOT.jar -cp demo/target/demo-1.0-SNAPSHOT.jar de.brokenpipe.dojo.undercovered.demo.Demo [2025-02-26 21:44:20] [INFO ] [Agent] In premain method [2025-02-26 21:44:20] [INFO ] transforming java/lang/Thread$ThreadNumbering [2025-02-26 21:44:20] [INFO ] transforming sun/launcher/LauncherHelper [2025-02-26 21:44:20] [INFO ] transforming de/brokenpipe/dojo/undercovered/demo/Demo [2025-02-26 21:44:20] [FINE ] visitMethod: [2025-02-26 21:44:20] [FINER ] instrument line: 3 [2025-02-26 21:44:20] [FINE ] visitMethod: main [2025-02-26 21:44:20] [FINER ] instrument line: 6 [2025-02-26 21:44:20] [FINER ] instrument line: 8 [2025-02-26 21:44:20] [FINER ] instrument line: 9 [2025-02-26 21:44:20] [FINER ] instrument line: 11 [2025-02-26 21:44:20] [FINE ] visitMethod: bla [2025-02-26 21:44:20] [FINER ] instrument line: 14 [2025-02-26 21:44:20] [FINER ] instrument line: 15 [2025-02-26 21:44:20] [INFO ] transforming jdk/internal/misc/MainMethodFinder [2025-02-26 21:44:20] [INFO ] transforming de/brokenpipe/dojo/undercovered/coverista/Tracker [2025-02-26 21:44:20] [FINE ] visitMethod: [2025-02-26 21:44:20] [FINER ] instrument line: 6 [2025-02-26 21:44:20] [FINE ] visitMethod: track [2025-02-26 21:44:20] [FINER ] instrument line: 9 [2025-02-26 21:44:20] [FINER ] instrument line: 10 [2025-02-26 21:44:20] [FINER ] instrument line: 11 [2025-02-26 21:44:20] [FINER ] instrument line: 12 [2025-02-26 21:44:20] [FINE ] visitMethod: [2025-02-26 21:44:20] [FINER ] instrument line: 5 [2025-02-26 21:44:20] [INFO ] transforming java/lang/ExceptionInInitializerError Exception in thread \"main\" [2025-02-26 21:44:20] [INFO ] transforming java/lang/Throwable$WrappedPrintStream [2025-02-26 21:44:20] [INFO ] transforming java/lang/Throwable$PrintStreamOrWriter java.lang.StackOverflowError at de.brokenpipe.dojo.undercovered.coverista.Tracker.track(Tracker.java:9) at de.brokenpipe.dojo.undercovered.coverista.Tracker.track(Tracker.java:9) at de.brokenpipe.dojo.undercovered.coverista.Tracker.track(Tracker.java:9) at de.brokenpipe.dojo.undercovered.coverista.Tracker.track(Tracker.java:9) at de.brokenpipe.dojo.undercovered.coverista.Tracker.track(Tracker.java:9) [...] The first few lines look promising, it‚Äôs crawling through the classes, logging the method names and telling that it‚Äôs instrumenting certain lines. As soon as the actual execution starts, it throws a StackOverflowError ‚Ä¶\n‚Ä¶ since, well, we instrumented ourselves üôà\nAlso it‚Äôs logging that it tried instrumenting stuff like jdk/internal/misc/MainMethodFinder, where it didn‚Äôt find any line numbers, hence didn‚Äôt do anything. But we can also just safely ignore all the java.*, jdk.* and sun.* classes.\nLet‚Äôs just slam in a simple if statement and return null:\nif (className.startsWith(\"java/\") || className.startsWith(\"sun/\") || className.startsWith(\"jdk/\") || className.startsWith(\"de/brokenpipe/dojo/undercovered/coverista/\")) { log.fine(\"*not* instrumenting class \" + className); return null; } ‚Ä¶ and try again:\n$ java -Djava.util.logging.config.file=./coverista/src/main/resources/logging.properties -javaagent:agent/target/agent-1.0-SNAPSHOT.jar -cp demo/target /demo-1.0-SNAPSHOT.jar de.brokenpipe.dojo.undercovered.demo.Demo [2025-02-26 21:54:49] [INFO ] [Agent] In premain method [2025-02-26 21:54:49] [FINE ] *not* instrumenting class java/lang/Thread$ThreadNumbering [2025-02-26 21:54:49] [FINE ] *not* instrumenting class sun/launcher/LauncherHelper [2025-02-26 21:54:49] [INFO ] transforming de/brokenpipe/dojo/undercovered/demo/Demo [2025-02-26 21:54:49] [FINE ] visitMethod: [2025-02-26 21:54:49] [FINER ] instrument line: 3 [2025-02-26 21:54:49] [FINE ] visitMethod: main [2025-02-26 21:54:49] [FINER ] instrument line: 6 [2025-02-26 21:54:49] [FINER ] instrument line: 8 [2025-02-26 21:54:49] [FINER ] instrument line: 9 [2025-02-26 21:54:49] [FINER ] instrument line: 11 [2025-02-26 21:54:49] [FINE ] visitMethod: bla [2025-02-26 21:54:49] [FINER ] instrument line: 14 [2025-02-26 21:54:49] [FINER ] instrument line: 15 [2025-02-26 21:54:49] [FINE ] *not* instrumenting class jdk/internal/misc/MainMethodFinder [2025-02-26 21:54:49] [FINE ] *not* instrumenting class de/brokenpipe/dojo/undercovered/coverista/Tracker [2025-02-26 21:54:49] [FINE ] *not* instrumenting class java/lang/StackTraceElement$HashedModules [2025-02-26 21:54:49] [FINER ] hit de.brokenpipe.dojo.undercovered.demo.Demo:6 [2025-02-26 21:54:49] [FINER ] hit de.brokenpipe.dojo.undercovered.demo.Demo:8 [2025-02-26 21:54:49] [FINER ] hit de.brokenpipe.dojo.undercovered.demo.Demo:14 Hello World [2025-02-26 21:54:49] [FINER ] hit de.brokenpipe.dojo.undercovered.demo.Demo:15 [2025-02-26 21:54:49] [FINER ] hit de.brokenpipe.dojo.undercovered.demo.Demo:9 [2025-02-26 21:54:49] [FINER ] hit de.brokenpipe.dojo.undercovered.demo.Demo:14 to the blarg [2025-02-26 21:54:49] [FINER ] hit de.brokenpipe.dojo.undercovered.demo.Demo:15 [2025-02-26 21:54:49] [FINER ] hit de.brokenpipe.dojo.undercovered.demo.Demo:11 [2025-02-26 21:54:49] [FINE ] *not* instrumenting class java/util/IdentityHashMap$IdentityHashMapIterator [2025-02-26 21:54:49] [FINE ] *not* instrumenting class java/util/IdentityHashMap$KeyIterator yay, it works ü•≥\nOur very simple tracker method keeps logging, which lines were hit. Obviously we‚Äôd still need to collect all the data and write it to a coverage report. But first let‚Äôs try our little new analyzer a bit more‚Ä¶\nTrying a Loop In the output above we‚Äôve already seen, that it hits lines 14 \u0026 15 twice each. That‚Äôs the invocation of our static bla method, that actually prints the lines. But wouldn‚Äôt it be cool to have a little for loop, that calls our method a few more times!?\nLet‚Äôs extend our simple demo code a little bit:\npublic class Demo2 { public static void main(final String[] argv) { final String greeting = \"Hello World\"; bla(greeting); for (int i = 0; i \u003c 3; i++) { bla(\"to the blarg\"); } final Supplier\u003cInteger\u003e numberSupplier = () -\u003e Integer.valueOf(42); bla(\"the value: \" + numberSupplier.get()); } private static void bla(final String greeting) { System.out.println(greeting); } } ‚Ä¶ again, nothing fancy.\nLet‚Äôs try \u0026 see\n$ java -Djava.util.logging.config.file=./coverista/src/main/resources/logging.properties -javaagent:agent/target/agent-1.0-SNAPSHOT.jar -cp demo/target /demo-1.0-SNAPSHOT.jar de.brokenpipe.dojo.undercovered.demo.Demo2 Error: Unable to initialize main class de.brokenpipe.dojo.undercovered.demo.Demo2 Caused by: java.lang.VerifyError: Expecting a stackmap frame at branch target 41 Exception Details: Location: de/brokenpipe/dojo/undercovered/demo/Demo2.main([Ljava/lang/String;)V @21: if_icmpge Reason: Expected stackmap frame at this location. Bytecode: 0000000: b800 1112 194c b800 1112 19b8 001d b800 0000010: 1103 3d1c 06a2 0014 b800 1112 21b8 001d 0000020: b800 1184 0201 a7ff edb8 0011 ba00 3400 0000030: 004d b800 112c b900 3801 00b8 003c ba00 0000040: 4800 00b8 001d b800 11b1 Stackmap Table: append_frame(@19,Object[#31],Integer) chop_frame(@44,1) ‚Ä¶ oh no üò†\nWhat‚Äôs a VerifyError after all? and what stackmap frame is it talking about!? That‚Äôs what Let‚Äôs create a Coverage Analyzer, Part 3 is about.\n","wordCount":"1631","inLanguage":"en","datePublished":"2025-02-26T00:00:00Z","dateModified":"2025-02-26T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://stefansiegl.de/2025/02/lets-create-a-coverage-analyzer-part-2/"},"publisher":{"@type":"Organization","name":"~stesie's musings","logo":{"@type":"ImageObject","url":"https://stefansiegl.de/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://stefansiegl.de/ accesskey=h title="~stesie's musings (Alt + H)">~stesie's musings</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://stefansiegl.de/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://stefansiegl.de/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://stefansiegl.de/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://stefansiegl.de/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Let's create a Coverage Analyzer, Part 2</h1><div class=post-meta>Status: üå± Seedling&nbsp;¬∑&nbsp;Planted:&nbsp;<span title='2025-02-26 00:00:00 +0000 UTC'>Feb 26, 2025</span>&nbsp;¬∑&nbsp;8 min</div></header><div class=post-content><p>This is part two of my journey creating a Java (Line) Coverage Analyzer.</p><p>Here we&rsquo;ll actually implement the Byte Code Instrumentation, as <a href=https://stefansiegl.de/2025/02/lets-create-a-coverage-analyzer-part-1/>pointed out in the first part</a>.</p><p>Since processing the Byte Code itself, i.e. reading the classes, finding the methods, processing line number information, is in itself a huge task, let&rsquo;s rely on <a href=https://asm.ow2.io/>the ASM library</a> for that.
After all JaCoCo and Cobertura also rely on that, so this seems to be a valid choice üòÇ</p><h2 id=hello-asm>Hello ASM<a hidden class=anchor aria-hidden=true href=#hello-asm>#</a></h2><p>Usage of ASM is after all pretty simple. It provides two classes <code>ClassReader</code> and <code>ClassWriter</code>, which both do what their names promise. ASM heavily relies on the visitor pattern, and <code>ClassWriter</code> itself extends the abstract <code>ClassVisitor</code> class.</p><p>The constructor of <code>ClassReader</code> does take either a <code>byte[]</code> or an <code>InputStream</code>, hence nothing fancy. A very simple example would look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>instrumentClass</span>(<span style=color:#66d9ef>final</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> classBytes) <span style=color:#66d9ef>throws</span> IOException {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>var</span> reader <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ClassReader(classBytes);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>var</span> writer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ClassWriter(0);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    reader.<span style=color:#a6e22e>accept</span>(writer, 0);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> writer.<span style=color:#a6e22e>toByteArray</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>&mldr; obviously this in itself isn&rsquo;t very useful, since it doesn&rsquo;t do anything üôÇ</p><p>But we can bring our own implementation of <code>ClassVisitor</code> to the table, which itself takes a <code>ClassVisitor</code> to delegate to and then starts taking action:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Log</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CoveristaClassVisitor</span> <span style=color:#66d9ef>extends</span> ClassVisitor {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CoveristaClassVisitor</span>(<span style=color:#66d9ef>final</span> ClassVisitor writer) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>super</span>(Opcodes.<span style=color:#a6e22e>ASM9</span>, writer);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> MethodVisitor <span style=color:#a6e22e>visitMethod</span>(<span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> access, <span style=color:#66d9ef>final</span> String name, <span style=color:#66d9ef>final</span> String descriptor,
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>final</span> String signature, <span style=color:#66d9ef>final</span> String<span style=color:#f92672>[]</span> exceptions) {
</span></span><span style=display:flex><span>		log.<span style=color:#a6e22e>fine</span>(<span style=color:#e6db74>&#34;visitMethod: &#34;</span> <span style=color:#f92672>+</span> name);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>visitMethod</span>(access, name, descriptor, signature, exceptions);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Nothing fancy here, we just pass the <code>ClassVisitor</code> to the parent constructor and override the <code>visitMethod</code>, logging the method name.</p><div class="admonition note"><div class=admonition-icon>‚ÑπÔ∏è</div><div class=admonition-body>You might wonder what the <code>Opcodes.ASM9</code> bit is. It&rsquo;s just setting the ASM API version we&rsquo;re relying on. And as of this writing, ASM9 is the latest (stable) one.</div></div><p>Given we have a <code>ClassVisitor</code> now, let&rsquo;s hook that into the <code>instrumentClass</code> method from above. The reader instance delegates to our visitor. Our visitor delegates to the writer. Like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>instrumentClass</span>(<span style=color:#66d9ef>final</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> classBytes) <span style=color:#66d9ef>throws</span> IOException {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>final</span> <span style=color:#66d9ef>var</span> reader <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ClassReader(classBytes);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>final</span> <span style=color:#66d9ef>var</span> writer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ClassWriter(0);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>final</span> <span style=color:#66d9ef>var</span> classVisitor <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CoveristaClassVisitor(writer);
</span></span><span style=display:flex><span>		reader.<span style=color:#a6e22e>accept</span>(classVisitor, 0);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> writer.<span style=color:#a6e22e>toByteArray</span>();
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>&mldr; and that&rsquo;s it. We have a <em>very</em> simple first <code>ClassVisitor</code> that logs all the method definitions it finds.</p><p>And given the return type of <code>visitMethod</code> you might already have noticed that there&rsquo;s a <code>MethodVisitor</code> as well. Given that we actually want to instrument the method, the obvious next step is to create our own implementation of such a <code>MethodVisitor</code> and hook it into our <code>visitMethod</code> call path.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Log</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CoveristaMethodVisitor</span> <span style=color:#66d9ef>extends</span> MethodVisitor {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CoveristaMethodVisitor</span>(<span style=color:#66d9ef>final</span> MethodVisitor methodVisitor) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>super</span>(Opcodes.<span style=color:#a6e22e>ASM9</span>, methodVisitor);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>visitLineNumber</span>(<span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> line, <span style=color:#66d9ef>final</span> Label start) {
</span></span><span style=display:flex><span>		log.<span style=color:#a6e22e>finer</span>(<span style=color:#e6db74>&#34;instrument line: &#34;</span> <span style=color:#f92672>+</span> line);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>visitLineNumber</span>(line, start);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>visitMethodInsn</span>(Opcodes.<span style=color:#a6e22e>INVOKESTATIC</span>, <span style=color:#e6db74>&#34;de/brokenpipe/dojo/undercovered/coverista/Tracker&#34;</span>, <span style=color:#e6db74>&#34;track&#34;</span>, <span style=color:#e6db74>&#34;()V&#34;</span>, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Again, the implementation is very straight forward. We receive a <code>MethodVisitor</code> instance, which we pass to the parent constructor. Then we override the <code>visitLineNumber</code> method, log the invocation, delegate to the next visitor first, &mldr; and then the magic happens: we also call <code>visitMethodInsn</code>, and ask it to write an <code>INVOKESTATIC</code> opcode for us.</p><p>The arguments to that invocation are also very simple: the (internal) class name, the method name and the type signature. The final <code>false</code> is assigned to an argument named <code>isInterface</code>.</p><p>Internally the <code>visitMethodInsn</code> call will allocate an entry in the constants pool and write the <code>INVOKESTATIC</code> opcode, referencing the new constant. ASM also does some bookkeeping, so it won&rsquo;t put the same constant to the pool over and over. Therefore we can happily invoke <code>visitMethodInsn</code> for each and every line number label we&rsquo;ll find, and the constant will be added only once.</p><h2 id=connecting-it-to-the-agent>Connecting it to the Agent<a hidden class=anchor aria-hidden=true href=#connecting-it-to-the-agent>#</a></h2><p>As we&rsquo;ve seen in the first part, our agent just needs to provide a <code>premain</code> method and register a transformer there. Like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Log</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UndercoveredAgent</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>premain</span>(<span style=color:#66d9ef>final</span> String agentArgs, <span style=color:#66d9ef>final</span> Instrumentation inst) {
</span></span><span style=display:flex><span>		log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;[Agent] In premain method&#34;</span>);
</span></span><span style=display:flex><span>		inst.<span style=color:#a6e22e>addTransformer</span>(<span style=color:#66d9ef>new</span> UndercoverTransformer());
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>Transformer</code> just has to implement, as shown, the <code>transform</code> method:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Log</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UndercoverTransformer</span> <span style=color:#66d9ef>implements</span> ClassFileTransformer {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>transform</span>(<span style=color:#66d9ef>final</span> Module module, <span style=color:#66d9ef>final</span> ClassLoader loader, <span style=color:#66d9ef>final</span> String className,
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>final</span> Class<span style=color:#f92672>&lt;?&gt;</span> classBeingRedefined, <span style=color:#66d9ef>final</span> ProtectionDomain protectionDomain, <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> classfileBuffer) {
</span></span><span style=display:flex><span>		log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;transforming &#34;</span> <span style=color:#f92672>+</span> className);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Instrumenter().<span style=color:#a6e22e>instrumentClass</span>(classfileBuffer);
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>catch</span> (<span style=color:#66d9ef>final</span> IOException e) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;instrumentation of &#39;&#34;</span> <span style=color:#f92672>+</span> className <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; failed&#34;</span>, e);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>&mldr; and the rest we&rsquo;ve seen above.</p><p>The full source code of <a href=https://github.com/stesie/undercovered/tree/naive>the above implementation can be found on GitHub</a>. Make sure to check out the branch named <code>naive</code>, which matches the current progress. The repo contains a multi-module Maven setup, therefore just run <code>mvn package</code> to build.</p><p>Finally, time has come to run it for the first time. The basic invocation of the minimalist demo application looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ java -cp demo/target/demo-1.0-SNAPSHOT.jar de.brokenpipe.dojo.undercovered.demo.Demo
</span></span><span style=display:flex><span>Hello World
</span></span><span style=display:flex><span>to the blarg
</span></span></code></pre></div><p>Obviously we want to add our agent to the mix, and also configure logging, so our log output on fine & finer levels will show up:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ java -Djava.util.logging.config.file<span style=color:#f92672>=</span>./coverista/src/main/resources/logging.properties -javaagent:agent/target/agent-1.0-SNAPSHOT.jar -cp demo/target/demo-1.0-SNAPSHOT.jar de.brokenpipe.dojo.undercovered.demo.Demo
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [INFO   ] [Agent] In premain method 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [INFO   ] transforming java/lang/Thread$ThreadNumbering 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [INFO   ] transforming sun/launcher/LauncherHelper 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [INFO   ] transforming de/brokenpipe/dojo/undercovered/demo/Demo 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINE   ] visitMethod: &lt;init&gt; 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINER  ] instrument line: 3 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINE   ] visitMethod: main 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINER  ] instrument line: 6 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINER  ] instrument line: 8 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINER  ] instrument line: 9 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINER  ] instrument line: 11 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINE   ] visitMethod: bla 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINER  ] instrument line: 14 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINER  ] instrument line: 15 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [INFO   ] transforming jdk/internal/misc/MainMethodFinder 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [INFO   ] transforming de/brokenpipe/dojo/undercovered/coverista/Tracker 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINE   ] visitMethod: &lt;init&gt; 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINER  ] instrument line: 6 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINE   ] visitMethod: track 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINER  ] instrument line: 9 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINER  ] instrument line: 10 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINER  ] instrument line: 11 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINER  ] instrument line: 12 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINE   ] visitMethod: &lt;clinit&gt; 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [FINER  ] instrument line: 5 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [INFO   ] transforming java/lang/ExceptionInInitializerError 
</span></span><span style=display:flex><span>Exception in thread &#34;main&#34; [2025-02-26 21:44:20] [INFO   ] transforming java/lang/Throwable$WrappedPrintStream 
</span></span><span style=display:flex><span>[2025-02-26 21:44:20] [INFO   ] transforming java/lang/Throwable$PrintStreamOrWriter 
</span></span><span style=display:flex><span>java.lang.StackOverflowError
</span></span><span style=display:flex><span>	at de.brokenpipe.dojo.undercovered.coverista.Tracker.track(Tracker.java:9)
</span></span><span style=display:flex><span>	at de.brokenpipe.dojo.undercovered.coverista.Tracker.track(Tracker.java:9)
</span></span><span style=display:flex><span>	at de.brokenpipe.dojo.undercovered.coverista.Tracker.track(Tracker.java:9)
</span></span><span style=display:flex><span>	at de.brokenpipe.dojo.undercovered.coverista.Tracker.track(Tracker.java:9)
</span></span><span style=display:flex><span>	at de.brokenpipe.dojo.undercovered.coverista.Tracker.track(Tracker.java:9)
</span></span><span style=display:flex><span>[...]
</span></span></code></pre></div><p>The first few lines look promising, it&rsquo;s crawling through the classes, logging the method names and telling that it&rsquo;s instrumenting certain lines. As soon as the actual execution starts, it throws a <code>StackOverflowError</code> &mldr;</p><p>&mldr; since, well, we instrumented ourselves üôà</p><p>Also it&rsquo;s logging that it tried instrumenting stuff like <code>jdk/internal/misc/MainMethodFinder</code>, where it didn&rsquo;t find any line numbers, hence didn&rsquo;t do anything. But we can also just safely ignore all the <code>java.*</code>, <code>jdk.*</code> and <code>sun.*</code> classes.</p><p>Let&rsquo;s just slam in a simple if statement and <code>return null</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>if</span> (className.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;java/&#34;</span>) <span style=color:#f92672>||</span> className.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;sun/&#34;</span>) <span style=color:#f92672>||</span> className.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;jdk/&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>||</span> className.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;de/brokenpipe/dojo/undercovered/coverista/&#34;</span>)) {
</span></span><span style=display:flex><span>    log.<span style=color:#a6e22e>fine</span>(<span style=color:#e6db74>&#34;*not* instrumenting class &#34;</span> <span style=color:#f92672>+</span> className);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>&mldr; and try again:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ java -Djava.util.logging.config.file<span style=color:#f92672>=</span>./coverista/src/main/resources/logging.properties -javaagent:agent/target/agent-1.0-SNAPSHOT.jar -cp demo/target
</span></span><span style=display:flex><span>/demo-1.0-SNAPSHOT.jar de.brokenpipe.dojo.undercovered.demo.Demo
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [INFO   ] [Agent] In premain method 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINE   ] *not* instrumenting class java/lang/Thread$ThreadNumbering 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINE   ] *not* instrumenting class sun/launcher/LauncherHelper 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [INFO   ] transforming de/brokenpipe/dojo/undercovered/demo/Demo 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINE   ] visitMethod: &lt;init&gt; 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINER  ] instrument line: 3 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINE   ] visitMethod: main 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINER  ] instrument line: 6 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINER  ] instrument line: 8 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINER  ] instrument line: 9 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINER  ] instrument line: 11 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINE   ] visitMethod: bla 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINER  ] instrument line: 14 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINER  ] instrument line: 15 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINE   ] *not* instrumenting class jdk/internal/misc/MainMethodFinder 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINE   ] *not* instrumenting class de/brokenpipe/dojo/undercovered/coverista/Tracker 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINE   ] *not* instrumenting class java/lang/StackTraceElement$HashedModules 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINER  ] hit de.brokenpipe.dojo.undercovered.demo.Demo:6 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINER  ] hit de.brokenpipe.dojo.undercovered.demo.Demo:8 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINER  ] hit de.brokenpipe.dojo.undercovered.demo.Demo:14 
</span></span><span style=display:flex><span>Hello World
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINER  ] hit de.brokenpipe.dojo.undercovered.demo.Demo:15 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINER  ] hit de.brokenpipe.dojo.undercovered.demo.Demo:9 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINER  ] hit de.brokenpipe.dojo.undercovered.demo.Demo:14 
</span></span><span style=display:flex><span>to the blarg
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINER  ] hit de.brokenpipe.dojo.undercovered.demo.Demo:15 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINER  ] hit de.brokenpipe.dojo.undercovered.demo.Demo:11 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINE   ] *not* instrumenting class java/util/IdentityHashMap$IdentityHashMapIterator 
</span></span><span style=display:flex><span>[2025-02-26 21:54:49] [FINE   ] *not* instrumenting class java/util/IdentityHashMap$KeyIterator 
</span></span></code></pre></div><p>yay, it works ü•≥</p><p>Our very simple tracker method keeps logging, which lines were hit. Obviously we&rsquo;d still need to collect all the data and write it to a coverage report. But first let&rsquo;s try our little new analyzer a bit more&mldr;</p><h2 id=trying-a-loop>Trying a Loop<a hidden class=anchor aria-hidden=true href=#trying-a-loop>#</a></h2><p>In the output above we&rsquo;ve already seen, that it hits lines 14 & 15 twice each. That&rsquo;s the invocation of our static <code>bla</code> method, that actually prints the lines. But wouldn&rsquo;t it be cool to have a little for loop, that calls our method a few more times!?</p><p>Let&rsquo;s extend our simple demo code a little bit:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo2</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>final</span> String<span style=color:#f92672>[]</span> argv) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>final</span> String greeting <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello World&#34;</span>;
</span></span><span style=display:flex><span>		bla(greeting);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 3; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>			bla(<span style=color:#e6db74>&#34;to the blarg&#34;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>final</span> Supplier<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> numberSupplier <span style=color:#f92672>=</span> () <span style=color:#f92672>-&gt;</span> Integer.<span style=color:#a6e22e>valueOf</span>(42);
</span></span><span style=display:flex><span>		bla(<span style=color:#e6db74>&#34;the value: &#34;</span> <span style=color:#f92672>+</span> numberSupplier.<span style=color:#a6e22e>get</span>());
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>bla</span>(<span style=color:#66d9ef>final</span> String greeting) {
</span></span><span style=display:flex><span>		System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(greeting);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>&mldr; again, nothing fancy.</p><p>Let&rsquo;s try & see</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ java -Djava.util.logging.config.file<span style=color:#f92672>=</span>./coverista/src/main/resources/logging.properties -javaagent:agent/target/agent-1.0-SNAPSHOT.jar -cp demo/target
</span></span><span style=display:flex><span>/demo-1.0-SNAPSHOT.jar de.brokenpipe.dojo.undercovered.demo.Demo2
</span></span><span style=display:flex><span>Error: Unable to initialize main class de.brokenpipe.dojo.undercovered.demo.Demo2
</span></span><span style=display:flex><span>Caused by: java.lang.VerifyError: Expecting a stackmap frame at branch target 41
</span></span><span style=display:flex><span>Exception Details:
</span></span><span style=display:flex><span>  Location:
</span></span><span style=display:flex><span>    de/brokenpipe/dojo/undercovered/demo/Demo2.main([Ljava/lang/String;)V @21: if_icmpge
</span></span><span style=display:flex><span>  Reason:
</span></span><span style=display:flex><span>    Expected stackmap frame at this location.
</span></span><span style=display:flex><span>  Bytecode:
</span></span><span style=display:flex><span>    0000000: b800 1112 194c b800 1112 19b8 001d b800
</span></span><span style=display:flex><span>    0000010: 1103 3d1c 06a2 0014 b800 1112 21b8 001d
</span></span><span style=display:flex><span>    0000020: b800 1184 0201 a7ff edb8 0011 ba00 3400
</span></span><span style=display:flex><span>    0000030: 004d b800 112c b900 3801 00b8 003c ba00
</span></span><span style=display:flex><span>    0000040: 4800 00b8 001d b800 11b1               
</span></span><span style=display:flex><span>  Stackmap Table:
</span></span><span style=display:flex><span>    append_frame(@19,Object[#31],Integer)
</span></span><span style=display:flex><span>    chop_frame(@44,1)
</span></span></code></pre></div><p>&mldr; oh no üò†</p><p>What&rsquo;s a <code>VerifyError</code> after all? and what stackmap frame is it talking about!? That&rsquo;s what <a href=https://stefansiegl.de/2025/03/lets-create-a-coverage-analyzer-part-3/>Let&rsquo;s create a Coverage Analyzer, Part 3</a> is about.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://stefansiegl.de/tags/java/>Java</a></li><li><a href=https://stefansiegl.de/tags/java-agents/>Java Agents</a></li><li><a href=https://stefansiegl.de/tags/byte-code/>Byte Code</a></li></ul></footer></article></main><footer class=footer><span>¬© 2025 Stefan Siegl ¬∑ all content is <a href=https://creativecommons.org/licenses/by-sa/4.0/deed>CC-BY-SA</a> ¬∑ <a href=https://www.swyx.io/digital-garden-tos#for-visitors>Terms of Service</a></span> ¬∑
<a href=/imprint>Imprint</a> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>
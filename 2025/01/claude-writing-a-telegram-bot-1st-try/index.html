<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Claude writing a Telegram Bot, 1st try | ~stesie's musings</title>
<meta name=keywords content="AI,Claude,Telegram,Image Recognition"><meta name=description content="This post is the first part, in a mini series (I&rsquo;m aiming for three posts in a row), where I try prompting Claude with different levels of verbosity and compare the results. Below you&rsquo;ll find results of my initial try in using Claude to write a Telegram Bot.
My ultimate goal is to figure out how much gas I need to heat my apartment. The gas meter is located in the hallway outside my apartment and doesn&rsquo;t have a digital interface to tap into."><meta name=author content><link rel=canonical href=https://stefansiegl.de/2025/01/claude-writing-a-telegram-bot-1st-try/><link crossorigin=anonymous href=/assets/css/stylesheet.eaf1c0e3f8327b0eecb58a6cafac5ca1bc09ab794ba654be960d9aa6b1cdd1c7.css integrity="sha256-6vHA4/gyew7stYpsr6xcobwJq3lLplS+lg2aprHN0cc=" rel="preload stylesheet" as=style><link rel=icon href=https://stefansiegl.de/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://stefansiegl.de/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://stefansiegl.de/favicon-32x32.png><link rel=apple-touch-icon href=https://stefansiegl.de/apple-touch-icon.png><link rel=mask-icon href=https://stefansiegl.de/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://stefansiegl.de/2025/01/claude-writing-a-telegram-bot-1st-try/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Claude writing a Telegram Bot, 1st try"><meta property="og:description" content="This post is the first part, in a mini series (I&rsquo;m aiming for three posts in a row), where I try prompting Claude with different levels of verbosity and compare the results. Below you&rsquo;ll find results of my initial try in using Claude to write a Telegram Bot.
My ultimate goal is to figure out how much gas I need to heat my apartment. The gas meter is located in the hallway outside my apartment and doesn&rsquo;t have a digital interface to tap into."><meta property="og:type" content="article"><meta property="og:url" content="https://stefansiegl.de/2025/01/claude-writing-a-telegram-bot-1st-try/"><meta property="article:section" content="pages"><meta property="article:published_time" content="2025-01-27T00:00:00+00:00"><meta property="article:modified_time" content="2025-01-27T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Claude writing a Telegram Bot, 1st try"><meta name=twitter:description content="This post is the first part, in a mini series (I&rsquo;m aiming for three posts in a row), where I try prompting Claude with different levels of verbosity and compare the results. Below you&rsquo;ll find results of my initial try in using Claude to write a Telegram Bot.
My ultimate goal is to figure out how much gas I need to heat my apartment. The gas meter is located in the hallway outside my apartment and doesn&rsquo;t have a digital interface to tap into."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Pages","item":"https://stefansiegl.de/pages/"},{"@type":"ListItem","position":2,"name":"Claude writing a Telegram Bot, 1st try","item":"https://stefansiegl.de/2025/01/claude-writing-a-telegram-bot-1st-try/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Claude writing a Telegram Bot, 1st try","name":"Claude writing a Telegram Bot, 1st try","description":"This post is the first part, in a mini series (I\u0026rsquo;m aiming for three posts in a row), where I try prompting Claude with different levels of verbosity and compare the results. Below you\u0026rsquo;ll find results of my initial try in using Claude to write a Telegram Bot.\nMy ultimate goal is to figure out how much gas I need to heat my apartment. The gas meter is located in the hallway outside my apartment and doesn\u0026rsquo;t have a digital interface to tap into.","keywords":["AI","Claude","Telegram","Image Recognition"],"articleBody":"This post is the first part, in a mini series (I’m aiming for three posts in a row), where I try prompting Claude with different levels of verbosity and compare the results. Below you’ll find results of my initial try in using Claude to write a Telegram Bot.\nMy ultimate goal is to figure out how much gas I need to heat my apartment. The gas meter is located in the hallway outside my apartment and doesn’t have a digital interface to tap into. Since I just rent the place and the meter is outside the apartment, I can’t tinker with it. The idea is to snap a quick picture of the meter in the morning and evening, or whenever I feel like it. Just in passing… and have the value automatically stored in a database for future analysis.\nIn short, it needs to be quick and easy. My initial thought was to create an iPhone app, perhaps using Flutterflow. However, since I don’t have an Apple Developer Account, that’s a bit tricky. The next idea that came to mind was Telegram. Send the image to a bot, and let it do the rest. Since I already have an API account with OpenAI, the image will be sent there. GPT-4o will read the meter reading, store it in a PostgreSQL table, and that’s it. That’s the plan…\nFirst try: being verbose while prompting step by step Before firing up Claude AI I quickly tried image recognition with GPT-4o and already played a little, what’s a proper prompt to read the meter value. Given that some numbers might be hard to read, since the meter is “in between” two values, I noticed to get more reliable results if I tell it, that the number has five digits before the comma, and three decimal places.\nAfter I found out that GPT is perfectly able to read the meter, and isn’t confused by any of the other numbers and/or text written onto the meter … I wanted to find out how to write a Telegram bot. To be honest, I’ve never tried that before, … neither with nor without an LLM as support.\nFurthermore I haven’t used Claude much before. But I heard that Claude would be better with JavaScript, and GPT better with Python … since I’m a JavaScript/TypeScript person, I went with claude and asked for JavaScript.\nAs I’m just on the free tier, and there was much traffic on their site, Claude 3.5 Sonnet wasn’t available. Therefore I went with the Haiku model. Going step by step, I started out asking how it would write a bot in the first place\nWhich JavaScript library would you use to create a telegram bot, that I would want to send images to?\nResponse:\nFor creating a Telegram bot in JavaScript that can send images, I recommend using the node-telegram-bot-api library. It provides a straightforward way to interact with the Telegram Bot API and supports sending images easily. Here’s a quick example:\nconst TelegramBot = require('node-telegram-bot-api'); const bot = new TelegramBot(token, {polling: true}); - // Sending an image bot.sendPhoto(chatId, 'path/to/image.jpg'); The library handles image uploads, supports various methods for sending media, and provides a robust set of features for Telegram bot development.\nOk, so it misunderstood me, that I want to send images. No idea how that comes, but let’s correct it right away:\nNo, I wouldn’t want the bot to send images, but receive them. Does this library handle it anyways?\nResponse:\nYes, node-telegram-bot-api handles receiving images as well. Here’s a simple example:\nbot.on('photo', (msg) =\u003e { const photo = msg.photo; // Access the photo details and download if needed }); The library provides methods to access image metadata and download received images, making it convenient for handling image uploads to your Telegram bot.\nOk, seems like this could work. So let’s just move on to resizing the image. The camera image will initially be quite large. OpenAI doesn’t accept images bigger than 2048px anyways, and it’s billing by block sizes of 512x512 pixels, … so let’s see how we can shrink the image\nok, fine. This image can be pretty big in size. How would you scale the image so it’s longer edge doesn’t have more than roughly 1000 pixels ?\nResponse:\nI’ll demonstrate how to resize an image using the Sharp library in Node.js:\nconst sharp = require('sharp'); bot.on('photo', async (msg) =\u003e { const fileId = msg.photo[msg.photo.length - 1].file_id; const file = await bot.getFile(fileId); const filePath = file.file_path; await sharp(filePath) .resize(1000, 1000, { fit: 'inside', withoutEnlargement: true }) .toFile('resized-image.jpg'); }); This code:\nRetrieves the highest resolution photo file Uses Sharp to resize, maintaining aspect ratio Ensures no edge exceeds 1000 pixels Prevents image enlargement if smaller Ok, that was easy. So let’s ask it to connect to OpenAI’s GPT API. Admittedly asking Claude to do so feels a little bit mean …\nNice! ok, so how would I send this image to OpenAI GPT API to run image recognition along with a prompting message “Wie lautet der Zählerstand auf dem Foto des Gaszählers. Die Zahl hat fünf Ziffern vor dem Komma und drei Nachkommastellen. Gib nur die Zahl aus, keinen Text davor oder danach” ?\nResponse:\nHere’s a code snippet to send the image to OpenAI’s API with the specified prompt:\nconst axios = require('axios'); const fs = require('fs'); bot.on('photo', async (msg) =\u003e { const fileId = msg.photo[msg.photo.length - 1].file_id; const file = await bot.getFile(fileId); const filePath = file.file_path; // Resize image with Sharp await sharp(filePath) .resize(1000, 1000, { fit: 'inside', withoutEnlargement: true }) .toFile('resized-image.jpg'); // Send to OpenAI API const response = await axios.post('https://api.openai.com/v1/chat/completions', { model: \"gpt-4-vision-preview\", messages: [ { role: \"user\", content: [ { type: \"text\", text: \"Wie lautet der Zählerstand auf dem Foto des Gaszählers. Die Zahl hat fünf Ziffern vor dem Komma und drei Nachkommastellen. Gib nur die Zahl aus, keinen Text davor oder danach\" }, { type: \"image_url\", image_url: { url: `data:image/jpeg;base64,${fs.readFileSync('resized-image.jpg', 'base64')}` } } ] } ], max_tokens: 300 }, { headers: { 'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`, 'Content-Type': 'application/json' } }); console.log(response.data.choices[0].message.content); }); Note: Requires setting OPENAI_API_KEY environment variable.\nLooks good so far. It cannot know that the model is no longer in preview. So let’s tell it that. I also wonder why it’s using axios over node-fetch, but likely it just has seen more examples with that one.\nI’m not sure why it’s using the temp file, therefore let’s briefly ask it:\nok, cool. you can just assume that meanwhile there is a model named gpt-4o-mini that’s good to use.\none question to the code, do I really need to create a temporary file on disk? (resized-image.jpg as you’ve called it)\nResponse:\nNo, you don’t need to create a temporary file. You can resize the image directly in memory using Sharp’s buffer methods:\nconst axios = require('axios'); bot.on('photo', async (msg) =\u003e { const fileId = msg.photo[msg.photo.length - 1].file_id; const file = await bot.getFile(fileId); const filePath = file.file_path; // Resize image to buffer const resizedImageBuffer = await sharp(filePath) .resize(1000, 1000, { fit: 'inside', withoutEnlargement: true }) .toBuffer(); // Send to OpenAI API const response = await axios.post('https://api.openai.com/v1/chat/completions', { model: \"gpt-4o-mini\", messages: [ { role: \"user\", content: [ { type: \"text\", text: \"Wie lautet der Zählerstand auf dem Foto des Gaszählers. Die Zahl hat fünf Ziffern vor dem Komma und drei Nachkommastellen. Gib nur die Zahl aus, keinen Text davor oder danach\" }, { type: \"image_url\", image_url: { url: `data:image/jpeg;base64,${resizedImageBuffer.toString('base64')}` } } ] } ], max_tokens: 300 }, { headers: { 'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`, 'Content-Type': 'application/json' } }); console.log(response.data.choices[0].message.content); }); This approach avoids creating a temporary file on disk.\nOkay, looks good on first sight. So let’s move on to the last step: saving things to the database:\nVery nice! Last but not least, how would I connect to a PostgreSQL database and insert a new record into a table called gas_meter, simply storing the number returned from the GPT model along with the current timestamp?\nResponse:\nHere’s how to connect to PostgreSQL and insert the gas meter reading:\nconst { Pool } = require('pg'); const pool = new Pool({ connectionString: process.env.DATABASE_URL }); bot.on('photo', async (msg) =\u003e { // Previous image processing and GPT API call code... const meterReading = response.data.choices[0].message.content; try { const client = await pool.connect(); await client.query( 'INSERT INTO gas_meter (reading, timestamp) VALUES ($1, NOW())', [meterReading] ); client.release(); } catch (err) { console.error('Database insert error:', err); } }); This code:\nUses pg library for PostgreSQL connection Connects via DATABASE_URL environment variable Inserts reading with current timestamp Handles connection and potential errors I’ve seen before, that GPT uses a comma, instead of a dot, to separate the decimal places. Let’s help Claude …\nTake into account, that the GPT may answer in German locale, so using a comma as a decimal separator. The database should save the value as a floating point number\nResponse:\nHere’s the updated code to handle German number format:\nbot.on('photo', async (msg) =\u003e { // Previous code... const meterReading = response.data.choices[0].message.content .replace(',', '.'); // Convert German decimal comma to dot try { const client = await pool.connect(); await client.query( 'INSERT INTO gas_meter (reading, timestamp) VALUES ($1, NOW())', [parseFloat(meterReading)] ); client.release(); } catch (err) { console.error('Database insert error:', err); } }); Key changes:\nReplace comma with dot Use parseFloat() to convert to a proper floating-point number Directly pass to PostgreSQL query Ok, so we have all pieces together. Let’s ask it to combine everything\nCool. So now let’s piece everything together. Create a Telegram bot in JavaScript language, that takes an images, scales it to not eat too many tokens. Feed it through GPT to read the number and store it to the database please!\nResponse:\nRequirements before running:\nSet environment variables: TELEGRAM_BOT_TOKEN OPENAI_API_KEY DATABASE_URL Install dependencies: npm install node-telegram-bot-api pg sharp axios Ensure PostgreSQL table exists with schema: CREATE TABLE gas_meter (reading FLOAT, timestamp TIMESTAMP); I like having .env files, at least while running stuff locally. So let’s ask it to add dotenv:\nModify the code so that it optionally reads from an .env file, if it exists\nResponse:\ntelegram-gas-meter-bot.js, second version\nKey changes:\nAdded check for .env file existence Uses dotenv to load environment variables if file exists Requires minimal additional setup Ok, so it was easy to run now. However it didn’t work. Giving Claude a clue:\nFirst of all, connection to telegram API seems to work just fine. However it fails to process the image with the following error message\nError processing gas meter reading: Error: Input file is missing: photos/file_0.jpg\nAny idea on that one?\nAnd adding to that, what do you think of adding more log output to the code?\nResponse:\nThe error suggests the bot isn’t correctly downloading the Telegram file. Here’s an improved version with more logging and file download:\ntelegram-gas-meter-bot.js, third version\nKey changes:\nAdded custom file download function Extensive console logging Explicit file URL construction Added file cleanup in finally block Log at bot startup This version should:\nExplicitly download the file from Telegram Provide more detailed logging Handle file download errors more robustly Getting closer, it messed up with the temp file (in line 55 here it’s assigning a const within the try block … however that’s out of scope in the finally block). Let’s tell it …\nnice, almost works. the GPT call is correct and the value is even stored to the database.\nHowever it fails to delete the file in the end, error message is this one:\nReferenceError: localFilePath is not defined\n… that leads me to the question, is it safe to assume the current directory is writable and we can hardcode a filename? shouldn’t this go to the temp directory and use a random filename instead?\nResponse:\nYou’re right. Here’s an improved version using the system’s temp directory and a random filename:\ntelegram-gas-meter-bot.js, fourth version\nKey changes:\nUse os.tmpdir() for temporary file location Generate random filename with crypto.randomBytes() Add null check for localFilePath before deletion Yay, it found out, that it needs a let before the try/catch 🙂 That one was actually working well. I just noticed that it would be nice to have some feedback\nPlease also make the bot reply with the meter reading, so as a user I have some feedback that everything worked successfully and can also verify, that the value was indeed read correctly\nResponse\ntelegram-gas-meter-bot.js, fifth version\nChanges:\nAdded bot.sendMessage() to reply with meter reading Added error message if processing fails Uses German language for messages Summary That went pretty smoothly. Including the time needed to create the Bot on Telegram and creating a fresh API key in the OpenAI backend, all together hardly took 15 minutes. After all putting together this post took me way longer 🙂\nAnd well, what more can I say, the code just works fine.\nHaving some user interface at hand now, I started out playing some more and quickly found out that GPT-4o yields way better results compared to GPT-4o-mini. The latter once failed to put the comma correctly, so it read a number 10 times too high. GPT-4o never did that.\nIf I wanted to nitpick on the code, …\nI think it’s weird, that it’s using https module to initially download the image from Telegram, but then uses axios to call GPT-4o\narguably it’s unnecessary to create a temporary file … especially since I asked it to remove the temp file, when it passes the scaled image to the LLM … it could have thought of not using a temp file for the file download\n… but hey, nothing too weird. Would it be in a code review, I likely asked to change the former and ignored the latter. And in the end, it just works, therefore I take it as it is 🙂\n","wordCount":"2283","inLanguage":"en","datePublished":"2025-01-27T00:00:00Z","dateModified":"2025-01-27T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://stefansiegl.de/2025/01/claude-writing-a-telegram-bot-1st-try/"},"publisher":{"@type":"Organization","name":"~stesie's musings","logo":{"@type":"ImageObject","url":"https://stefansiegl.de/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://stefansiegl.de/ accesskey=h title="~stesie's musings (Alt + H)">~stesie's musings</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://stefansiegl.de/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://stefansiegl.de/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://stefansiegl.de/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://stefansiegl.de/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Claude writing a Telegram Bot, 1st try</h1><div class=post-meta>Status: 🌱 Seedling&nbsp;·&nbsp;Planted:&nbsp;<span title='2025-01-27 00:00:00 +0000 UTC'>Jan 27, 2025</span>&nbsp;·&nbsp;11 min</div></header><div class=post-content><p>This post is the first part, in a mini series (I&rsquo;m aiming for three posts in a row), where I try prompting Claude with different levels of verbosity and compare the results. Below you&rsquo;ll find results of my initial try in using Claude to write a Telegram Bot.</p><p>My ultimate goal is to figure out how much gas I need to heat my apartment. The gas meter is located in the hallway outside my apartment and doesn&rsquo;t have a digital interface to tap into. Since I just rent the place and the meter is outside the apartment, I can&rsquo;t tinker with it. The idea is to snap a quick picture of the meter in the morning and evening, or whenever I feel like it. Just in passing&mldr; and have the value automatically stored in a database for future analysis.</p><p><img loading=lazy src=/assets/gasmeter.png alt="Photo of my gas meter, reading 00773,078 m3"></p><p>In short, it needs to be quick and easy. My initial thought was to create an iPhone app, perhaps using Flutterflow. However, since I don&rsquo;t have an Apple Developer Account, that&rsquo;s a bit tricky. The next idea that came to mind was Telegram. Send the image to a bot, and let it do the rest. Since I already have an API account with OpenAI, the image will be sent there. GPT-4o will read the meter reading, store it in a PostgreSQL table, and that&rsquo;s it. That&rsquo;s the plan&mldr;</p><h2 id=first-try-being-verbose-while-prompting-step-by-step>First try: being verbose while prompting step by step<a hidden class=anchor aria-hidden=true href=#first-try-being-verbose-while-prompting-step-by-step>#</a></h2><p>Before firing up Claude AI I quickly tried image recognition with GPT-4o and already played a little, what&rsquo;s a proper prompt to read the meter value. Given that some numbers might be hard to read, since the meter is &ldquo;in between&rdquo; two values, I noticed to get more reliable results if I tell it, that the number has five digits before the comma, and three decimal places.</p><p>After I found out that GPT is perfectly able to read the meter, and isn&rsquo;t confused by any of the other numbers and/or text written onto the meter &mldr; I wanted to find out how to write a Telegram bot. To be honest, I&rsquo;ve never tried that before, &mldr; neither with nor without an LLM as support.</p><p>Furthermore I haven&rsquo;t used Claude much before. But I heard that Claude would be better with JavaScript, and GPT better with Python &mldr; since I&rsquo;m a JavaScript/TypeScript person, I went with claude and asked for JavaScript.</p><p>As I&rsquo;m just on the free tier, and there was much traffic on their site, Claude 3.5 Sonnet wasn&rsquo;t available. Therefore I went with the Haiku model. Going step by step, I started out asking how it would write a bot in the first place</p><blockquote><p>Which JavaScript library would you use to create a telegram bot, that I would want to send images to?</p></blockquote><p>Response:</p><blockquote><p>For creating a Telegram bot in JavaScript that can send images, I recommend using the <code>node-telegram-bot-api</code> library. It provides a straightforward way to interact with the Telegram Bot API and supports sending images easily. Here&rsquo;s a quick example:</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;node-telegram-bot-api&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, {<span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>});
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> <span style=color:#75715e>// Sending an image
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#39;path/to/image.jpg&#39;</span>);
</span></span></code></pre></div><blockquote><p>The library handles image uploads, supports various methods for sending media, and provides a robust set of features for Telegram bot development.</p></blockquote><p>Ok, so it misunderstood me, that I want to <em>send</em> images. No idea how that comes, but let&rsquo;s correct it right away:</p><blockquote><p>No, I wouldn&rsquo;t want the bot to send images, but receive them. Does this library handle it anyways?</p></blockquote><p>Response:</p><blockquote><p>Yes, <code>node-telegram-bot-api</code> handles receiving images as well. Here&rsquo;s a simple example:</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;photo&#39;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>photo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Access the photo details and download if needed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>});
</span></span></code></pre></div><blockquote><p>The library provides methods to access image metadata and download received images, making it convenient for handling image uploads to your Telegram bot.</p></blockquote><p>Ok, seems like this could work. So let&rsquo;s just move on to resizing the image. The camera image will initially be quite large. OpenAI doesn&rsquo;t accept images bigger than 2048px anyways, and it&rsquo;s billing by block sizes of 512x512 pixels, &mldr; so let&rsquo;s see how we can shrink the image</p><blockquote><p>ok, fine. This image can be pretty big in size. How would you scale the image so it&rsquo;s longer edge doesn&rsquo;t have more than roughly 1000 pixels ?</p></blockquote><p>Response:</p><blockquote><p>I&rsquo;ll demonstrate how to resize an image using the Sharp library in Node.js:</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sharp</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;sharp&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;photo&#39;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>file</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>getFile</span>(<span style=color:#a6e22e>fileId</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>file_path</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>sharp</span>(<span style=color:#a6e22e>filePath</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>resize</span>(<span style=color:#ae81ff>1000</span>, <span style=color:#ae81ff>1000</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>fit</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;inside&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>withoutEnlargement</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>toFile</span>(<span style=color:#e6db74>&#39;resized-image.jpg&#39;</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><blockquote><p>This code:</p><ul><li>Retrieves the highest resolution photo file</li><li>Uses Sharp to resize, maintaining aspect ratio</li><li>Ensures no edge exceeds 1000 pixels</li><li>Prevents image enlargement if smaller</li></ul></blockquote><p>Ok, that was easy. So let&rsquo;s ask it to connect to OpenAI&rsquo;s GPT API. Admittedly asking Claude to do so feels a little bit mean &mldr;</p><blockquote><p>Nice! ok, so how would I send this image to OpenAI GPT API to run image recognition along with a prompting message &ldquo;Wie lautet der Zählerstand auf dem Foto des Gaszählers. Die Zahl hat fünf Ziffern vor dem Komma und drei Nachkommastellen. Gib nur die Zahl aus, keinen Text davor oder danach&rdquo; ?</p></blockquote><p>Response:</p><blockquote><p>Here&rsquo;s a code snippet to send the image to OpenAI&rsquo;s API with the specified prompt:</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>axios</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;axios&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;fs&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;photo&#39;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>file</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>getFile</span>(<span style=color:#a6e22e>fileId</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>file_path</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Resize image with Sharp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>sharp</span>(<span style=color:#a6e22e>filePath</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>resize</span>(<span style=color:#ae81ff>1000</span>, <span style=color:#ae81ff>1000</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>fit</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;inside&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>withoutEnlargement</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>toFile</span>(<span style=color:#e6db74>&#39;resized-image.jpg&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Send to OpenAI API
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>axios</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;https://api.openai.com/v1/chat/completions&#39;</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>model</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;gpt-4-vision-preview&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>messages</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;user&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;text&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Wie lautet der Zählerstand auf dem Foto des Gaszählers. Die Zahl hat fünf Ziffern vor dem Komma und drei Nachkommastellen. Gib nur die Zahl aus, keinen Text davor oder danach&#34;</span>
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;image_url&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>image_url</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>url</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`data:image/jpeg;base64,</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>readFileSync</span>(<span style=color:#e6db74>&#39;resized-image.jpg&#39;</span>, <span style=color:#e6db74>&#39;base64&#39;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>max_tokens</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>300</span>
</span></span><span style=display:flex><span>  }, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Authorization&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Bearer </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>OPENAI_API_KEY</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/json&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>choices</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>content</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><blockquote><p>Note: Requires setting <code>OPENAI_API_KEY</code> environment variable.</p></blockquote><p>Looks good so far. It cannot know that the model is no longer in preview. So let&rsquo;s tell it that.
I also wonder why it&rsquo;s using <code>axios</code> over <code>node-fetch</code>, but likely it just has seen more examples with that one.</p><p>I&rsquo;m not sure why it&rsquo;s using the temp file, therefore let&rsquo;s briefly ask it:</p><blockquote><p>ok, cool. you can just assume that meanwhile there is a model named gpt-4o-mini that&rsquo;s good to use.</p><p>one question to the code, do I really need to create a temporary file on disk? (resized-image.jpg as you&rsquo;ve called it)</p></blockquote><p>Response:</p><blockquote><p>No, you don&rsquo;t need to create a temporary file. You can resize the image directly in memory using Sharp&rsquo;s buffer methods:</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>axios</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;axios&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;photo&#39;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>file</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>getFile</span>(<span style=color:#a6e22e>fileId</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>file_path</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Resize image to buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>resizedImageBuffer</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>sharp</span>(<span style=color:#a6e22e>filePath</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>resize</span>(<span style=color:#ae81ff>1000</span>, <span style=color:#ae81ff>1000</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>fit</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;inside&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>withoutEnlargement</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>toBuffer</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Send to OpenAI API
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>axios</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;https://api.openai.com/v1/chat/completions&#39;</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>model</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;gpt-4o-mini&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>messages</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;user&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;text&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Wie lautet der Zählerstand auf dem Foto des Gaszählers. Die Zahl hat fünf Ziffern vor dem Komma und drei Nachkommastellen. Gib nur die Zahl aus, keinen Text davor oder danach&#34;</span>
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;image_url&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>image_url</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>url</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`data:image/jpeg;base64,</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>resizedImageBuffer</span>.<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#39;base64&#39;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>max_tokens</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>300</span>
</span></span><span style=display:flex><span>  }, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Authorization&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Bearer </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>OPENAI_API_KEY</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/json&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>choices</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>content</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><blockquote><p>This approach avoids creating a temporary file on disk.</p></blockquote><p>Okay, looks good on first sight. So let&rsquo;s move on to the last step: saving things to the database:</p><blockquote><p>Very nice! Last but not least, how would I connect to a PostgreSQL database and insert a new record into a table called <code>gas_meter</code>, simply storing the number returned from the GPT model along with the current timestamp?</p></blockquote><p>Response:</p><blockquote><p>Here&rsquo;s how to connect to PostgreSQL and insert the gas meter reading:</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>Pool</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;pg&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pool</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Pool</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connectionString</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>DATABASE_URL</span>
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;photo&#39;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Previous image processing and GPT API call code...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>meterReading</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>choices</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>content</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>connect</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>query</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;INSERT INTO gas_meter (reading, timestamp) VALUES ($1, NOW())&#39;</span>, 
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>meterReading</span>]
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>release</span>();
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Database insert error:&#39;</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><blockquote><p>This code:</p><ul><li>Uses pg library for PostgreSQL connection</li><li>Connects via DATABASE_URL environment variable</li><li>Inserts reading with current timestamp</li><li>Handles connection and potential errors</li></ul></blockquote><p>I&rsquo;ve seen before, that GPT uses a comma, instead of a dot, to separate the decimal places. Let&rsquo;s help Claude &mldr;</p><blockquote><p>Take into account, that the GPT may answer in German locale, so using a comma as a decimal separator. The database should save the value as a floating point number</p></blockquote><p>Response:</p><blockquote><p>Here&rsquo;s the updated code to handle German number format:</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;photo&#39;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Previous code...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>meterReading</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>choices</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>content</span>
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#39;,&#39;</span>, <span style=color:#e6db74>&#39;.&#39;</span>); <span style=color:#75715e>// Convert German decimal comma to dot
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>connect</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>query</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;INSERT INTO gas_meter (reading, timestamp) VALUES ($1, NOW())&#39;</span>, 
</span></span><span style=display:flex><span>      [parseFloat(<span style=color:#a6e22e>meterReading</span>)]
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>release</span>();
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Database insert error:&#39;</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><blockquote><p>Key changes:</p><ul><li>Replace comma with dot</li><li>Use parseFloat() to convert to a proper floating-point number</li><li>Directly pass to PostgreSQL query</li></ul></blockquote><p>Ok, so we have all pieces together. Let&rsquo;s ask it to combine everything</p><blockquote><p>Cool. So now let&rsquo;s piece everything together. Create a Telegram bot in JavaScript language, that takes an images, scales it to not eat too many tokens. Feed it through GPT to read the number and store it to the database please!</p></blockquote><p>Response:</p><blockquote><p>Requirements before running:</p><ol><li>Set environment variables:<ul><li>TELEGRAM_BOT_TOKEN</li><li>OPENAI_API_KEY</li><li>DATABASE_URL</li></ul></li><li>Install dependencies: npm install node-telegram-bot-api pg sharp axios</li><li>Ensure PostgreSQL table exists with schema: CREATE TABLE gas_meter (reading FLOAT, timestamp TIMESTAMP);</li></ol></blockquote><p>I like having .env files, at least while running stuff locally. So let&rsquo;s ask it to add dotenv:</p><blockquote><p>Modify the code so that it optionally reads from an .env file, if it exists</p></blockquote><p>Response:</p><blockquote><p><a href=https://github.com/stesie/gaszaehler-bot-1/blob/2c4012df8d4d5bbffc171448176e20689789df08/telegram-gas-meter-bot.js>telegram-gas-meter-bot.js, second version</a></p></blockquote><blockquote><p>Key changes:</p><ul><li>Added check for .env file existence</li><li>Uses dotenv to load environment variables if file exists</li><li>Requires minimal additional setup</li></ul></blockquote><p>Ok, so it was easy to run now. However it didn&rsquo;t work. Giving Claude a clue:</p><blockquote><p>First of all, connection to telegram API seems to work just fine. However it fails to process the image with the following error message</p><p>Error processing gas meter reading: Error: Input file is missing: photos/file_0.jpg</p><p>Any idea on that one?</p><p>And adding to that, what do you think of adding more log output to the code?</p></blockquote><p>Response:</p><blockquote><p>The error suggests the bot isn&rsquo;t correctly downloading the Telegram file. Here&rsquo;s an improved version with more logging and file download:</p></blockquote><blockquote><p><a href=https://github.com/stesie/gaszaehler-bot-1/blob/296e94d528fc904db2a083ce37e768264fd6a410/telegram-gas-meter-bot.js>telegram-gas-meter-bot.js, third version</a></p></blockquote><blockquote><p>Key changes:</p><ul><li>Added custom file download function</li><li>Extensive console logging</li><li>Explicit file URL construction</li><li>Added file cleanup in finally block</li><li>Log at bot startup</li></ul><p>This version should:</p><ol><li>Explicitly download the file from Telegram</li><li>Provide more detailed logging</li><li>Handle file download errors more robustly</li></ol></blockquote><p>Getting closer, it messed up with the temp file (<a href=https://github.com/stesie/gaszaehler-bot-1/blob/296e94d528fc904db2a083ce37e768264fd6a410/telegram-gas-meter-bot.js#L55>in line 55 here</a> it&rsquo;s assigning a <code>const</code> within the <code>try</code> block &mldr; however that&rsquo;s out of scope in the <code>finally</code> block). Let&rsquo;s tell it &mldr;</p><blockquote><p>nice, almost works. the GPT call is correct and the value is even stored to the database.</p><p>However it fails to delete the file in the end, error message is this one:</p><p>ReferenceError: localFilePath is not defined</p><p>&mldr; that leads me to the question, is it safe to assume the current directory is writable and we can hardcode a filename? shouldn&rsquo;t this go to the temp directory and use a random filename instead?</p></blockquote><p>Response:</p><blockquote><p>You&rsquo;re right. Here&rsquo;s an improved version using the system&rsquo;s temp directory and a random filename:</p></blockquote><blockquote><p><a href=https://github.com/stesie/gaszaehler-bot-1/blob/272f11e3e09e90d751d8ce48c5cbb384deb438ba/telegram-gas-meter-bot.js>telegram-gas-meter-bot.js, fourth version</a></p></blockquote><blockquote><p>Key changes:</p><ul><li>Use os.tmpdir() for temporary file location</li><li>Generate random filename with crypto.randomBytes()</li><li>Add null check for localFilePath before deletion</li></ul></blockquote><p>Yay, it found out, that it needs a <code>let</code> before the <code>try</code>/<code>catch</code> 🙂
That one was actually working well. I just noticed that it would be nice to have some feedback</p><blockquote><p>Please also make the bot reply with the meter reading, so as a user I have some feedback that everything worked successfully and can also verify, that the value was indeed read correctly</p></blockquote><p>Response</p><blockquote><p><a href=https://github.com/stesie/gaszaehler-bot-1/blob/9d4a5076657a98f71e41ef26d7af1035c23ec5ed/telegram-gas-meter-bot.js>telegram-gas-meter-bot.js, fifth version</a></p></blockquote><blockquote><p>Changes:</p><ul><li>Added bot.sendMessage() to reply with meter reading</li><li>Added error message if processing fails</li><li>Uses German language for messages</li></ul></blockquote><h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h2><p>That went pretty smoothly. Including the time needed to create the Bot on Telegram and creating a fresh API key in the OpenAI backend, all together hardly took 15 minutes. After all putting together this post took me way longer 🙂</p><p>And well, what more can I say, the code just works fine.</p><p>Having some user interface at hand now, I started out playing some more and quickly found out that GPT-4o yields way better results compared to GPT-4o-mini. The latter once failed to put the comma correctly, so it read a number 10 times too high. GPT-4o never did that.</p><p>If I wanted to nitpick on the code, &mldr;</p><ul><li><p>I think it&rsquo;s weird, that it&rsquo;s using <code>https</code> module to initially download the image from Telegram, but then uses <code>axios</code> to call GPT-4o</p></li><li><p>arguably it&rsquo;s unnecessary to create a temporary file &mldr; especially since I asked it to remove the temp file, when it passes the scaled image to the LLM &mldr; it could have thought of not using a temp file for the file download</p></li></ul><p>&mldr; but hey, nothing too weird. Would it be in a code review, I likely asked to change the former and ignored the latter. And in the end, it just works, therefore I take it as it is 🙂</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://stefansiegl.de/tags/ai/>AI</a></li><li><a href=https://stefansiegl.de/tags/claude/>Claude</a></li><li><a href=https://stefansiegl.de/tags/telegram/>Telegram</a></li><li><a href=https://stefansiegl.de/tags/image-recognition/>Image Recognition</a></li></ul></footer></article></main><footer class=footer><span>© 2025 Stefan Siegl · all content is <a href=https://creativecommons.org/licenses/by-sa/4.0/deed>CC-BY-SA</a> · <a href=https://www.swyx.io/digital-garden-tos#for-visitors>Terms of Service</a></span> ·
<a href=/imprint>Imprint</a> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>
<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>funny Math.random behaviour | ~stesie's musings</title>
<meta name=keywords content="V8Js,V8 Heap Snapshots"><meta name=description content="Playing around with V8&rsquo;s custom startup snapshots I noticed some funny behaviour regarding Math.random.
It is clear that if you call Math.random() within the custom startup code the generated random numbers are baked into the snapshot and then not so random anymore. If you call Math.random() at runtime, without custom startup code, it just behaves as expected: it generates random numbers. However if you have custom startup code, calling Math.random() early on startup, it correctly generates random numbers during startup but it breaks runtime random number generation causing weird error messages like"><meta name=author content><link rel=canonical href=https://stefansiegl.de/2016/03/math-random-fun/><link crossorigin=anonymous href=/assets/css/stylesheet.afb210dc38e6603228aff7827128220ab3093c72a2408955745ba993ab2977e6.css integrity="sha256-r7IQ3DjmYDIor/eCcSgiCrMJPHKiQIlVdFupk6spd+Y=" rel="preload stylesheet" as=style><link rel=icon href=https://stefansiegl.de/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://stefansiegl.de/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://stefansiegl.de/favicon-32x32.png><link rel=apple-touch-icon href=https://stefansiegl.de/apple-touch-icon.png><link rel=mask-icon href=https://stefansiegl.de/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://stefansiegl.de/2016/03/math-random-fun/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="funny Math.random behaviour"><meta property="og:description" content="Playing around with V8&rsquo;s custom startup snapshots I noticed some funny behaviour regarding Math.random.
It is clear that if you call Math.random() within the custom startup code the generated random numbers are baked into the snapshot and then not so random anymore. If you call Math.random() at runtime, without custom startup code, it just behaves as expected: it generates random numbers. However if you have custom startup code, calling Math.random() early on startup, it correctly generates random numbers during startup but it breaks runtime random number generation causing weird error messages like"><meta property="og:type" content="article"><meta property="og:url" content="https://stefansiegl.de/2016/03/math-random-fun/"><meta property="article:section" content="pages"><meta property="article:published_time" content="2016-03-05T00:00:00+00:00"><meta property="article:modified_time" content="2025-01-03T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="funny Math.random behaviour"><meta name=twitter:description content="Playing around with V8&rsquo;s custom startup snapshots I noticed some funny behaviour regarding Math.random.
It is clear that if you call Math.random() within the custom startup code the generated random numbers are baked into the snapshot and then not so random anymore. If you call Math.random() at runtime, without custom startup code, it just behaves as expected: it generates random numbers. However if you have custom startup code, calling Math.random() early on startup, it correctly generates random numbers during startup but it breaks runtime random number generation causing weird error messages like"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Pages","item":"https://stefansiegl.de/pages/"},{"@type":"ListItem","position":2,"name":"funny Math.random behaviour","item":"https://stefansiegl.de/2016/03/math-random-fun/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"funny Math.random behaviour","name":"funny Math.random behaviour","description":"Playing around with V8\u0026rsquo;s custom startup snapshots I noticed some funny behaviour regarding Math.random.\nIt is clear that if you call Math.random() within the custom startup code the generated random numbers are baked into the snapshot and then not so random anymore. If you call Math.random() at runtime, without custom startup code, it just behaves as expected: it generates random numbers. However if you have custom startup code, calling Math.random() early on startup, it correctly generates random numbers during startup but it breaks runtime random number generation causing weird error messages like","keywords":["V8Js","V8 Heap Snapshots"],"articleBody":"Playing around with V8’s custom startup snapshots I noticed some funny behaviour regarding Math.random.\nIt is clear that if you call Math.random() within the custom startup code the generated random numbers are baked into the snapshot and then not so random anymore. If you call Math.random() at runtime, without custom startup code, it just behaves as expected: it generates random numbers. However if you have custom startup code, calling Math.random() early on startup, it correctly generates random numbers during startup but it breaks runtime random number generation causing weird error messages like\nTypeError: Cannot read property '4' of undefined @virgofx raised this issue at the V8 issue tracker.\nFor the moment I came up with using random numbers from PHP’s Mersenne Twister\n$this-\u003ev8 = new V8Js('PHP', [], [], true, $blob); $this-\u003ev8-\u003e__random = function() { return mt_rand() / mt_getrandmax(); }; $this-\u003ev8-\u003eexecuteString('Math.random = PHP.__random; '); ","wordCount":"143","inLanguage":"en","datePublished":"2016-03-05T00:00:00Z","dateModified":"2025-01-03T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://stefansiegl.de/2016/03/math-random-fun/"},"publisher":{"@type":"Organization","name":"~stesie's musings","logo":{"@type":"ImageObject","url":"https://stefansiegl.de/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://stefansiegl.de/ accesskey=h title="~stesie's musings (Alt + H)">~stesie's musings</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://stefansiegl.de/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://stefansiegl.de/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://stefansiegl.de/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://stefansiegl.de/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">funny Math.random behaviour</h1><div class=post-meta>Planted:&nbsp;<span title='2016-03-05 00:00:00 +0000 UTC'>Mar 5, 2016</span>&nbsp;·&nbsp;1 min</div></header><div class=post-content><p>Playing around with V8&rsquo;s <a href=http://v8project.blogspot.de/2015/09/custom-startup-snapshots.html>custom startup snapshots</a> I noticed some funny behaviour regarding <code>Math.random</code>.</p><p>It is clear that if you call <code>Math.random()</code> within the custom startup code the generated random numbers are baked into the snapshot and then not so random anymore. If you call <code>Math.random()</code> at runtime, without custom startup code, it just behaves as expected: it generates random numbers. However if you have custom startup code, calling <code>Math.random()</code> early on startup, it correctly generates random numbers during startup but it breaks runtime random number generation causing weird error messages like</p><pre tabindex=0><code>TypeError: Cannot read property &#39;4&#39; of undefined
</code></pre><p>@virgofx raised this <a href="https://bugs.chromium.org/p/v8/issues/detail?id=4810">issue at the V8 issue tracker</a>.</p><p>For the moment I came up with using random numbers from PHP&rsquo;s Mersenne Twister</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>v8</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>V8Js</span>(<span style=color:#e6db74>&#39;PHP&#39;</span>, [], [], <span style=color:#66d9ef>true</span>, $blob);
</span></span><span style=display:flex><span>$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>v8</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>__random</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>() { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>mt_rand</span>() <span style=color:#f92672>/</span> <span style=color:#a6e22e>mt_getrandmax</span>(); };
</span></span><span style=display:flex><span>$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>v8</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>executeString</span>(<span style=color:#e6db74>&#39;Math.random = PHP.__random; &#39;</span>);
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://stefansiegl.de/tags/v8js/>V8Js</a></li><li><a href=https://stefansiegl.de/tags/v8-heap-snapshots/>V8 Heap Snapshots</a></li></ul></footer></article></main><footer class=footer><span>© 2025 Stefan Siegl · all content is <a href=https://creativecommons.org/licenses/by-sa/4.0/deed>CC-BY-SA</a> · <a href=https://www.swyx.io/digital-garden-tos#for-visitors>Terms of Service</a></span> ·
<a href=/imprint>Imprint</a> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>